\documentclass[en]{../../../eplsummary}
\usepackage{listings}
\usepackage{float}
\usepackage{graphicx}

\newcommand{\proitem}{\item[\textbf{\color{green!80!black}{$+$}}]}
\newcommand{\consitem}{\item[\textbf{\color{red!80!black}{$-$}}]}

\hypertitle{embedded-INGI2146}{8}{INGI}{2146}
{Gorby Nicolas Kabasele Ndonda\and Nicolas Houtain}
{Professor}

\section{Introduction}
\begin{description}
    \item[Mobile:] Portable devices with wireless communication,
        running stand-alone or client applications.
    \item[Embedded:] An embedded system is a computer system with
        a dedicated function within a larger mechanical or electrical system.
\end{description}

Embedded systems are everywhere in smartphones, cars,\ldots Typical
characteristics is the following:
\begin{itemize}
    \item Cheap
    \item Reduced power consumption
    \item Real-time
    \item Robust
\end{itemize}

To achieve these characteristic, there need to be a tight coupling between
the hardware, the OS and the application.

\subsection{Real-Time Systems}

Real-Time Systems monitor and have an impact on the physical world via sensors
and actuators. Because of their nature, they have
requirements/constraints on timing:

\begin{description}
    \item[Hard constraint]
        \begin{itemize}
            \item Potentially severe consequences if reaction/result is produced after
                deadline.
            \item Results has no value (or even negative value) after deadline
        \end{itemize}
    \item[Firm constraint]
        \begin{itemize}
            \item Occasional miss tolerated, but degrades QoS
            \item No or little value after deadline
        \end{itemize}
    \item[Soft constraint]
        \begin{itemize}
            \item Result still has value after deadline
        \end{itemize}
\end{description}

\begin{center}
    \includegraphics[width=0.7\linewidth]{img/realtime.png}
\end{center}

\subsection{Real-Time Tasks}
\begin{description}
    \item[Periodic:] Must be executed with fixed interarrival time
    \item[Sporadic:] Have known minimum interarrival time
    \item[Aperiodic:] No known interarrival time
\end{description}

\subsection{Wireless Sensor Networks}

Wireless Sensor Networks are composed of node (\textit{mote}) used for
monitoring and they communicates with each other and/or a remote server.

\subsubsection{Resource Constraint}
\begin{itemize}
    \item \textbf{Power}
        \begin{itemize}
            \item Batteries and Energy Harvesting
            \item Turn off idle devices
            \item Requires efficient OS and applications
            \item Reduce communication
        \end{itemize}

        \textit{Duty cycle} is the percentage of one period in which a
        signal or system active $\rightarrow$ isolated node will have
        high duty cycle

    \item \textbf{Bandwidth}
    \item \textbf{Memory}: just a few kBytes
    \item \textbf{CPU}: a few MHz
    \item \textbf{Data Transmission}: not enough power to reach server
        directly $\Rightarrow$ Multihop wireless Network
        \begin{itemize}
            \item Dynamic routing
            \item Self-Organizing Networks
        \end{itemize}
    \item Security: Not enough resources for sophisticated intrusion detection,
        encryption.
    \item Hardware: optimized
    \item \textbf{Reliable Data Flow}: Use 2-bit error correction and
        3-bit error detection.
        \begin{itemize}
            \item Store packet at source in circular buffer on flash 
            \item Remove data from source flash when End2End ack. (There
                is also data link ack)
        \end{itemize}
\end{itemize}

IoT = network of physical objects equipped with electronics and network
connectivity that can be sensed and controlled remotely.

\section{Operating Systems}

\subsection{Hardware}

\begin{description}
    \item[Microcontroller Unit]: Contains 
        \begin{itemize}
            \item CPU
            \item Memory (RAM and non-volatile)
            \item Interfaces to sensors and actuators
            \item Communication interfaces and interfaces to external memory
        \end{itemize}

    \item[JTAG] (Joint test action group): Allows to write code and data
        into flash memory or RAM of the MCU without using one of the
        communication interface
    \item[BSL] (Bootstrap Loader): similar JTAG but from a serial interface

        \begin{itemize}
            \item Can be used to debbuging code on the MCU from a PC
            \item Can upload code/data to the memory without any OS or program
                running.
        \end{itemize}

    \item[$\Rightarrow$] JTAG/BSL are useful for completely empty
        device where we can upload code/data without any OS.

    \item[Transceiver] Used to send data and receive data 
    \item[Interfaces and Sensors] Interfaces to sensor/Actuators
\end{description}

\subsection{Interrupts}
In order to make a software that react to the physical world two strategy:

\begin{description}
    \item[Polling] Read status of I/O every few milliseconds $\to$ waste of
        energy because CPU always busy

    \item[Interrupts] Signal to processor that current code execution should be interrupted
        because something important has happened.
        \begin{itemize}
            \item CPU stops execution and jumps to a specific place in the code that is 
                responsible for handling the interrupt
            \item Exist in all CPUs
            \item Handle by OS and device drivers
            \item Interrupts are expensive because of \textbf{context switching}
        \end{itemize} 
\end{description}

\subsection{OS for embedded systems}
OS are not necessary needed but they free the programmer from some concerns
\begin{itemize}
    \item Handle interrupts (events triggered when something happens)
    \item Manage memory
    \item Write your own process scheduler if you need multi-processing for
        background task
\end{itemize}

\paragraph{Linux}
Linux can be used for embedded systems but
\begin{itemize}
    \item requires enough memory 
    \item preemptive scheduling leads to latency for user code as
        kernel code cannot be preempted
\end{itemize}

\subsection{Real-Time OS}
OS specifically designed for real-time systems:
\begin{itemize}
    \item Much smaller than desktop/server OS
    \item Reduced set of functionality
    \item Fast context switch
    \item Guaranteed time-bounded response to interrupts
    \item Tries to avoid code that cannot be preempted
\end{itemize}

\subsection{OSs for WSN}
\begin{itemize}
    \item Thin abstraction layer to hardware(I/O, timers, \ldots)
    \item Limited multiprocessing
    \item Specific network protocol implementations
    \item Power saving
\end{itemize}

\subsubsection{TinyOS}
TinyOS applications consist of components that you can use in your own
application (as a \textit{set of libraries}). Each component is provided
with an interfaces defining the commands (function) and event available
in the component.

\begin{itemize}
    \item The device sleeps most of the time and they wake up when
        an event is triggered.
    \item Event-handling function execute and then device goes back to sleep.
\end{itemize}

\paragraph{Task}
Tasks are functions that can be preempted by interrupts but not by other tasks.
\begin{itemize}
    \item Task scheduler is a FIFO queue
    \item Not possible to post the same task while it is in the queue
    \item Device sleeps when task queue is empty and no event to process
\end{itemize}

\paragraph{Synchronous vs Asynchronous}
Hardware events can happen at any time and interrupt the current execution.
This can result in race conditions for variables shared between hardware and
task.
Compile differentiates between
\begin{itemize}
    \item Synchronous code: reachable only from tasks
    \item Asynchronous code: reachable from interrupts
\end{itemize}

Static analysis allows compiler to detect race conditions so programmer
are forced to explicitly use atomic section.

\paragraph{Optimization}
\begin{itemize}
    \item TinyOS programmed in NesC (subset of C)$\to$ No pointers or 
        dynamic allocation.
    \item Static analysis is used for optimization $\to$ can reduce apps by 60\%
\end{itemize}

\subsubsection{Contiki}
Differences with TinyOS
\begin{itemize}
    \item No special description language
    \item Cooperative process instead of task queue
    \item Core (kernal + libraries) is uploaded once
    \item Applications can be loaded at run-time
\end{itemize}
Application are composed of one or multiple processes. Proccesses are
cooperative, meaning that other processes can only run if current process
stops.
\begin{itemize}
    \item Processes communicate with each other by posting event
        \begin{itemize}
            \item Synchronous events: delivered immediately
            \item Asynchronous events: delivered later
        \end{itemize}
    \item Processes implemented as Proto-Threads
        \begin{itemize}
            \item Like threads but cheaper
            \item No separate stack per process $\to$ Local variables lose
                their value after a context switch
        \end{itemize}
    \item Process can be preempted by interrupts triggerd by hardware events.
\end{itemize}
\subsubsection{RIOT}
RIOT application programmed in C or C++ and used Multi-threading 
(not event-driven). $\to$ Use priority based scheduling.

\subsection{Networking Stacks}
uIP : Ipv4 stack in 4-5 KBytes of code.
\begin{itemize}
    \item One single packet buffer $\to$ easier to manage
    \item Incoming packet must be processed immediately $\to$ Radio interface queue
        incoming packet while processing.
    \item Retransmission is left to the application to recreate lost
        packet segments (not too bad if we considerer that packet
        contained sensor data, in this case new data are sent)
    \item Send segment one at the time, wait ACK before sending next segment

        $\Rightarrow$ saves memory, simplifies implementation but
        affects performance
    \item One single buffer for IP fragment reassembly
\end{itemize}


\section{TinyDB}
%%TODO


\section{Real-Time Scheduling}
\begin{description}
    \item[Job/processes/threads]: A task to be executed which compete for
        limited resource, the CPU
    \item[Scheduling:] Given N jobs, in which order should the CPU execute
        them
\end{description}

\paragraph{Scheduling goals}:

\begin{tabular}{lm{0.45\linewidth}m{0.45\linewidth}}
    & In general purposes OS( Linux,Windows, \ldots) &
    Real-time OS \\
    &
    \begin{description}
        \item[Fairness] All jobs should be finally executed (no starvation)
        \item[Optimize response time] Should be as short as possible on average
        \item[Optimize throughput] serve as many jobs as possible on average
            (Time to wait for CPU + Execution Time)
    \end{description}
    &
    In real-time system it's a bit different, the 
    \begin{itemize}
        \item most important thing is that task meets their deadline
        \item Don't care about fairness and throughput
        \item Focus on worst-case performance instead of average performance
    \end{itemize}
\end{tabular}

\subsection{Scheduling in general purpose OS}
Based on the idea of Round Robin scheduling which is preemptive with time
slice:
\begin{enumerate}
    \item All jobs wait in a queue for the CPU
    \item Job at the head of the queue receives service for time quantum Q
    \item Then it is interrupted by the next waiting job and goes back to the
        end of the queue
    \item Repeated until job is finished
    \item If Q is small, illusion of parallelism but careful of the cost for
        context switching
\end{enumerate}
By default all jobs are equal: order in queue is order of arrival and same time
slice for all jobs. But there are some variation with different priority and 
different time slice. Priority can be assigned manually or automatically

\subsection{Schedulability in real-time}
\begin{itemize}
    \item Given a set of tasks with their periods, deadlines, etc.
    \item Given a scheduling algorithm
    \item[$\Rightarrow$] The task set is \textbf{schedulable} if all jobs meet their deadlines.
\end{itemize}

Ways to know if task set is schedulable:
\begin{tabular}{l}
    Measurement on real system : expensive!\\
    Simulation\\
    \textcolor{red}{Mathematical analysis}\\
\end{tabular}

\paragraph{Assumption}
\begin{itemize}
    \item Single CPU
    \item No priority inversion
    \item Zero overhead for context switching
    \item Fixed number $N$ of independent periodic tasks with
        period $T_i$ and deadline $D_i$ (relative to begin of period), $i$=1,\ldots, $N$
    \item Task $i$ has a worst-case execution time $C_i$
\end{itemize}

\subsubsection{Rate Monotonic Scheduling}

RM is on \textcolor{red}{optimal} preemptive static priority scheduling
algorithm. It assigns a static priority to each task, the task with the shortest period
has highest priority. Preemption is possible.
\newline

Assuming $D_i=T_i$ for all tasks, a sufficient (but too pessimistic) test 
for schedulability with RM is:
$$\sum_{i=1}^N \frac{C_i}{T_i}\leq N(2^{\frac{1}{N}}-1)$$

\begin{center}
    \includegraphics[width=0.5\linewidth]{img/RM.png}
\end{center}

RM is easy to implement with low overhead since task priorities are set at 
design time and does not change during run time but RM does not 
allow high CPU utilization because scheduling too rigid

\paragraph{Worst Case Execution Time}
To know worst case execution we can either do measurement or use static analysis

\subsubsection{Deadline Monotonic Scheduling}

RM does is not good for $D_i < T_i$, so in DM, task with shortest deadline
has highest priority. DM is on \textcolor{red}{optimal} preemptive static priority scheduling
algorithm for $D_i<T_i$.
$$\sum_{i=1}^N \frac{C_i}{D_i}\leq N(2^{\frac{1}{N}}-1)$$

\begin{center}
    \includegraphics[width=0.5\linewidth]{img/RM.png}
\end{center}

\subsubsection{Response Time Analysis}
RTA provides a sufficient and necessary test for all fixed-priority preemptive 
scheduling algorithms (RM,DM,\ldots)\\
A task set is schedulable if worst-case response time $R_i \leq D_i$ for all tasks.
\begin{itemize}
    \item Response time $R_i$ = $C_i + I_i$ where $I_i$ is the worst
        case interference time = amount of time a task is delayed by
        execution of higher priority tasks
\end{itemize}

\begin{eqnarray}
    R_i =& C_i + I_i\\
    R_i =& C_i + \sum_{j\in hp(i)} \lceil \frac{R_i}{T_j}\rceil C_j
    \label{rta-eq}
\end{eqnarray}

where hp(i) is the set of tasks with higher priotity than task i 
$\to \lceil \frac{R_i}{T_j}\rceil$ is the number of preemptions of task i by task j.



~\eqref{rta-eq} is a recursive formula so it is solve by finding smallest fixed point:
$$R_i^0 = C_i$$
$$R_i^{m+1} = C_i + \sum_{j \in hp(i)} \lceil \frac{R_i^m}{T_j}\rceil C_j$$

\subsubsection{Earliest Deadline First}

Optimal preemptive \textbf{dynamic} priority scheduling algorithm 
where task with earliest absolute deadline has the highest priority. The
absolute deadline is the time when the job is ready + $D_i$.

\subsection{Scheduling with resource lock}

We have assumed that task are independent, in a real systems, tasks can
be dependent because they access a shared resource in a critical section
(CS). In this case, a task with highest priority can be
\textbf{unboundedly} blocked by tasks with lower priority. Response time
becomes: $$R_i = C_i + I_i + B_i$$ where $B_i$ is the time the task is
blocked because a resource has been locked.

\begin{center}
    \includegraphics[width=0.5\linewidth]{img/priority.png}
\end{center}

\paragraph{Note:} RTA a test only sufficient, not necessary with blocking.

\paragraph{Priority inversion problem}

\begin{center}
    \includegraphics[width=0.5\linewidth]{img/inversion.png}
\end{center}

\subsubsection{Priority Inheritance Protocol}

To avoid this problem, a low-priority task inherits the priority of the 
blocked high-priority task.
\begin{itemize}
    \item When task i is blocked by a CS held by task k 
        and prio(i) > prio(k) $\to$ prio(k) := prio(i)
    \item When task k leaves the CS:
        \begin{itemize}
            \item If task k no longer blocks any tasks, it returns to its old priority
            \item If task k still blocks other tasks, it inherits their highest priority
        \end{itemize}
\end{itemize}

\subsubsection{Priority Ceiling Protocol}
Alternative to priority inheritance, a shared resource R can be accessed
only tasks $S_R = \{ t_1,\ldots,t_m\}$.
\begin{itemize}
    \item Assign a priority ceiling $C_R$ to that resource
        $$C_R = max_{t_i\in S}(prio(t_i))$$
    \item When a task locks that resource, its priority is immediately
        boosted to $C_R$
\end{itemize}

\paragraph{Note:}
Priority inheritance and priority ceiling require a scheduler that can handle
dynamic priorities

\subsection{Aperiodic/sporadic tasks}

\begin{itemize}
    \item \textbf{With hard deadlines}
        \begin{enumerate}
            \item \begin{itemize}
                    \item Take the lowest inter-arrival time L of those tasks
                    \item Treat them as a virtual periodic task with period L in 
                        schedulability analysis
                    \item[$\Rightarrow$]Too pessimistic
                \end{itemize}
        \end{enumerate} 

    \item \textbf{Without hard deadlines}
        \begin{enumerate}
            \item \begin{itemize}
                    \item Maintain the hard deadlines for the periodic tasks
                    \item Try to reduce response time for the other tasks
                \end{itemize}

                Simple and no impact on periodic tasks but possibly very
                long response times if the system is very busy with
                periodic task

            \item Polling server
                \begin{itemize}
                    \item A periodic task (''server'') with period $T_S$ to serve 
                        aperiodic/sporadic requests
                    \item Incoming aperiodic/sporadic jobs are queued in a queue
                    \item In one execution period, the server only runs up to $C_S$ time units
                \end{itemize}
                Performance can be controlled by the period and the priority of the server
                tasks and by $C_S$. 

                \begin{itemize}
                    \item Advantage: Polling server can be treated like a periodic task with
                        WCET $C_S$
                    \item Disadvantage: If an aperiodic/sporadic job is not handled by the
                        server in a time period, it has to wait for the next period $\to$ 
                        response time increases
                    \item Can be extended to multiple servers with different priorities,
                        periods and $C_S$ for different classes/types jobs.
                \end{itemize}
        \end{enumerate}
\end{itemize}


\section{Wireless Communication}

\begin{tabular}{|l|ccc|}
    \hline
    Classification & Mobile & Wireless Sensor Network & Internet Of Things\\
    \hline
    Network size & Millions & Thousand & Millions to Billions? \\
    Range & 100 to 1000$km^2$ & $m^2$ to $km^2$ & $m^2$ to $km^2$\\
    Mobility & Mobile & Static or mobile & Static or mobile \\
    Roaming & Yes & x & x \\
    Energy & Not critical & Critical & x \\
    Speed & Best without constraint & x & x \\
    \hline
\end{tabular}


\subsection{Radio spectrum}
Not all frequencies are equally suitable for all purpose
\begin{itemize}
    \item $\neq$ propagation properties
    \item $\neq$ power emission
    \item Some a reserved (police, phone) other are license free
\end{itemize}

\subsection{Path loss}

Signal strength is attenuated as the electromagnetic wave propagates
through space.

\subsubsection{Free-space loss}
Attenuation depends on frequency and distance
$$\frac{P_r}{P_t} = G_t \times G_r \times ( \frac{\lambda}{4\pi R})^2$$
where \begin{tabular}{rl}
    $P_r,P_t$ & is the received and transmitted power\\
    $G_r,G_t$ & is the received and transmitted antenna gain\\
    $R$ & is the distance between transmitter and receiver\\
    $\lambda$ & is the wave length\\
\end{tabular}

$$PL[dB] = 10 log\frac{P_t}{P_r} = - 10 log\frac{P_r}{P_t}$$

\subsubsection{Others loss}
\begin{center}
    \includegraphics[width=0.7\linewidth]{img/loss.png}
\end{center}

\begin{itemize}
    \item Reflection and refraction depend on material and wave
        length
    \item Multi-path (scattering, diffraction,...)
        $$\frac{P_r}{P_t} = G_t \times G_r \times ( \frac{\lambda}{4\pi
        R})^\gamma$$
        where $\gamma$ is 3-5 in cities, 4-6 in buildings,...
    \item Noise due to
        \begin{itemize}
            \item Receiver electronics
            \item Interference on wireless channel:
                B far away to be detected by A, but still causes
                interference in form of background noise.
                \begin{center}
                    \includegraphics[width=0.5\linewidth]{img/ranges.png}
                \end{center}

                \paragraph{Hidden stations}: (1) C cannot detect A, (2) send data to B
                but (3) B cannot receive because A is sending
                \paragraph{Far stations}: (1) A is closer to B than C so
                (2) signal of A so strong that B cannot receive C
        \end{itemize}

        Stronger the noise, harder for the receiver to interpret signal
        as a symbol ($0-1$).
        \begin{itemize}
            \item Expressed as Signal-To-Noise: $$SNIR = 10 log(\frac{P_r}{N_0 + \sum_j I_j})$$ 
                where \begin{tabular}{rl} $P_r$ & Received signal power \\
                $N_0$ & Noise power \\
                $I_j$ & Influence of interfering neighbor $j$
            \end{tabular}

        \item With an appropriate Medium Access protocol (we will see
            that later), interference can be reduced. SNIR simplifies to
            SNR (Signal-Noise-Ratio)
            $$SNR=10 log(\frac{P_r}{P_N})$$
            where \begin{tabular}{rl} $P_r$ & Received signal power \\
            $P_N$ & noise power varies from locality\\
        \end{tabular}
\end{itemize}
\end{itemize}

\subsubsection{Error Rate} 
\begin{itemize}
    \item BER (Bit Error Rate): Number of bit errors per time unit
        $\Rightarrow$ depends on $SNR$

        $p_b$ is the probability that a received bit will be in error
    \item PER (Packet Error Rate): Packet rate error.
        $p_p$ is the probability that a received packet has an error
\end{itemize}

$$p_p = 1 - (1 - p_b)^N$$ where $N$ is the packet size


\subsection{Physical layer}

%\begin{center}
%    \includegraphics[width=0.6\linewidth]{img/osi.png}
%\end{center}
\begin{center}
    \includegraphics[width=0.8\linewidth]{img/physical.png}
\end{center}

\subsubsection{Channel encoding}
\begin{itemize}
    \item Add error detection code to the data (parity bits, CRC)
    \item Block coding 

    \item interleaving (shuffle symbols): As electromagnetic spikes can
        cause burst errors, many errors in one code word $\Rightarrow$
        exceeds error-correcting capabilities.

        Shuffle symbols to distribute error over several words: Hello
        World $\rightarrow$ HWeol rllod
\end{itemize}

\subsubsection{Modulation}
Radio wave as sine function: $signal(t) = A \times sin(2\pi \times t
\times f + \phi)$ with Amplitude (A), Frequency (f) and Phase ($\phi$).


Modulation manipulates these parameters as a function of time to
transmit data.
\begin{center}
    \includegraphics[width=0.6\linewidth]{img/modulation.png}
\end{center}

Challenge: bit synchronization, frame synchronization, listing same
frequency, noise, interference,...


\section{Medium access}

Control medium access, but allow concurrent medium usage $\Rightarrow$
multiplexing.

\begin{table}[!h]
    \begin{tabular}{|r|cccc|}
        \hline
        & SDMA & FDMA & TDMA & CDMA \\
        \hline
        Coordination & None & Frequency assignment & Time synchronization & Code coordinations \\
        Viable & x & x & v & v \\
        \hline
    \end{tabular}
\end{table}

\begin{itemize}
    \item \textbf{Space Division Multiple Access (SDMA)}: divide space
        so that devices do not interfere.
        \begin{center}
            \includegraphics[width=0.6\linewidth]{img/SDMA.png}
        \end{center}

        \begin{itemize}
            \item Simple, but pure SDMA require huge secure distance and one
                station per end point: not viable in practice without other
                multiplex methods!
        \end{itemize}

    \item \textbf{Frequency Division Multiple Access (FDMA)}:
        Frequencies permanently assigned to transmission channels
        \begin{center}
            \includegraphics[width=0.6\linewidth]{img/FDMA.png}
        \end{center}

        \begin{itemize}
            \item One frequency per station and these frequency require
                \textit{guard-bands} between them such that they are more robust
                against interferences
        \end{itemize}
        \begin{center}
            \includegraphics[width=0.3\linewidth]{img/guard.png}
        \end{center}

    \item \textbf{Time Division Multiple Access (TDMA)}:
        Time is divided into slots and only one station per slot can
        access medium
        \begin{center}
            \includegraphics[width=0.6\linewidth]{img/TDMA.png}
        \end{center}

        \begin{itemize}
            \item One frequency, time division can be done in
                control software 
            \item but $\Rightarrow$ Require \textbf{exact timing} between stations
                (use \textit{guard-times} between slots to be more tolerant
                against timing variations)
        \end{itemize}

    \item \textbf{Code Division Multiple Access (CDMA)}: Each sender
        uses a different code that is applied to the data stream and if
        receiver know the code it can decode the data.

        \begin{enumerate}
            \item Sender A: \begin{tabular}{l} send bit=1\\
                Code=010011\\ Ouput = (-1 +1 -1 -1 +1 +1)\end{tabular}
            \item Sender B: \begin{tabular}{l} send bit=0\\
                Code=110101\\ Ouput = (-1 -1 +1 -1 +1 -1)\end{tabular}
            \item superimposed: (-2 0 0 -2 +2 0)
            \item Extract A: (-2 0 0 -2 +2 0) * (-1 +1 -1 -1 +1 +1) = 6
                $\geq$ 0 $\Rightarrow$ original bit is 1
        \end{enumerate}

        \begin{itemize}
            \item Need much longer codes which needs more bandwidth than
                original. 
            \item Coordination between station to have different code or
                stations choose code randomly
            \item Senders have to adapt their transmission power to all have
                the same strength at a receiver
        \end{itemize}
\end{itemize}

\subsection{Assignment}

Instead of have a central manager who assigns resources which can leads
to a waste of resources if node doest not want to send:
\begin{itemize}
    \item \textbf{Demand-based assignment}
        \begin{itemize}
            \item \textit{Polling}: Ask is node has something to
                transmit, if not ask next node.

                $\Rightarrow$ Overhead and not scalable + need
                central coordination

            \item \textit{Token-passing}: token is a special signal
                or packet

                $\Rightarrow$ Need to know next node + token
                regeneration if it is loss + what about fairness if
                node keep token for long time
        \end{itemize}

    \item \textbf{Random access}: Sends when it wants with
        collisions possibilities.

        $\Rightarrow$ Fully distributed without coordinator
        but collisions increases with number of nodes and
        traffic load
\end{itemize}


\subsection{ALOHAnet}
\begin{itemize}
    \item All node send packets/frame of identical duration $T$ on a single
        channel ($\rightarrow$ TDMA)

    \item Collisions possible if two node sends a packet at same time,
        to avoid this:
        \begin{enumerate}
            \item Sender sends a packet
            \item Collision happens
            \item Receiver receives a garbled packet
                \begin{itemize}
                    \item Receiver does not send ACK to sender
                    \item Sender knows that collision has happened
                \end{itemize}
            \item Sender waits a random time in the range [0,...,B] (“backoff period”)
            \item Send tries again (-> Step 1)
        \end{enumerate}

    \item Use time slots to limited collision to one timeslots (require
        synchronized clock on all nodes)

    \item Carrier-Sense Multiple Access (CSMA): node listen for a free
        channel before sending (if busy, wait for a random time)

        $\Rightarrow$ Still collision because of propagation delay

    \item CSMA with Collision Detection (CSMA/CD): node listening while
        sending in order to detect collision at receiver (need complex
        hardware)

        $\Rightarrow$ No loss time to send end of frame when collision
        detected

    \item CSMA/CA: 
        \begin{itemize}
            \item If channel free 
                \begin{enumerate}
                    \item Node wait for channel stay free for the IFS time
                        (Inter-Frame Spacing)
                    \item Node sends
                \end{enumerate}
            \item If channel is in use 
                \begin{enumerate} 
                    \item Node waits until current transmission is over
                    \item Node waits for channel to stay free for the IFS time
                    \item Node waits additional random backoff time
                \end{enumerate}
        \end{itemize}

        \begin{center}
            \includegraphics[width=0.7\linewidth]{img/CSMA.png}
        \end{center}

    \item CSMA/CA with ACK: ACK frames are given higher priority than
        normal data frames $\Rightarrow$ Receiver wait Shorter IFS
        (SIFS < IFS) before sending

    \item CSMA/CA with RTS/CTS: solve the \textit{hidden station
        problem} (CSMA/CA and CSMA/CD are still unreliable with this
        problem)
        \begin{enumerate}
            \item Before sending data, node A sends RTS (Request to
                Send) control frame to node B after medium was
                free for IFS time
            \item  Node B sends CTS (Clear to Send) to node A after
                medium was free for SIFS time
            \item Node C also hears the CTS frame -> node C waits
            \item Node A can send now
        \end{enumerate}

        $\Rightarrow$ Collision still possible for RTS, CTS packet which has
        a small impact as these control frame packet are smaller.
\end{itemize}


\section{802.15.4}

Defines \textbf{physical} and \textbf{MAC} layer for wireless Personal Area
networks (PAN). 2.4GHz, low range (75m), low rate (250kbits/s) for
low-power devices.

\textbf{Physical layer}: one form of CDMA

\subsection{Network topology}
Two types of nodes:
\begin{itemize}
    \item Full Functional Devices (FFD): can act as PAN coordinators
    \item Reduced Functional Devices (RFD): simple \& cheep
\end{itemize}
\begin{center}
    \includegraphics[width=0.5\linewidth]{img/802_topo.png}
\end{center}
Many upper-layer protocols define their own topologies
on top of the P2P topology.

\subsection{Addresses}
64-bits unique MAC address or 16 bits short address.
\begin{itemize}
    \item Too save memory: node get 16-bits short address
        assigned by coordinator when joining network (only
        valid inside PAN)
    \item Inter-PAN communication possible with a
        optional 16-bits PAN identifier
\end{itemize}

\subsection{Security}
Optional frame encryption supported with various
ciphers (e.g. AES-CCM 128 bit).
\begin{itemize}
    \item Frame header is authenticated, payload is encrypted
    \item Key management must be provided by higher layers
\end{itemize}

\subsection{Medium Access Control}
Implemented in software (as no need to very high performance):
\begin{itemize}
    \item CSMA/CA: wait idle channel or wait random backoff interval
        (0-2.24ms)
    \item Receiver check packet's CRC
    \item MAC layer can send ACK frame which are broadcasted
        (optional as many upper-layer protocols implements their
        own ACK mechanism)
\end{itemize}

\subsubsection{Unslotted mode}
Only CSMA/CA is used:
\begin{itemize}
    \item Very simple to implement 
    \item PAN coordinator not involved
    \item[But] need to continuously listen instead of sleep
        (power consuming)
\end{itemize}

\subsubsection{Slotted mode}

\begin{center}
    \includegraphics[width=0.5\linewidth]{img/slotted.png}
\end{center}

\begin{itemize}
    \item B = Beacon frame periodically sent by coordinator
    \item CAP = CSMA/CA period
    \item CFP = Guaranteed timeslots assigned by coordinator to nodes
    \item[Properties] 
        \begin{itemize}
            \item More complex. Requires coordinator.
            \item Allows Real-Time operation
            \item Nodes can sleep during inactivity period
        \end{itemize}
\end{itemize}

\section{Above 802.15.4}

\subsection{ZigBee}

Define on top of 802.15.4:
\begin{itemize}
    \item \textbf{Network layer}: 
        \begin{itemize}
            \item support slotted and unslotted mode,
                16-bits short addresses and 64-bits extended addresses
            \item Routing based on distance vector algorithm for tree, star
                and mesh topologies
        \end{itemize}
    \item \textbf{Security layer}: 128-bits AES, device responsible for
        key distribution
    \item \textbf{Application layer}: 
        \begin{itemize}
            \item High-level application framework that structure
                the capabilities of sensors in Application Objects
            \item Also provides service discovery, defines application
                profiles, message formats,...
        \end{itemize}
\end{itemize}

\subsection{Refresh IPv6}

\begin{center}
    \includegraphics[width=0.7\linewidth]{img/IPV6.png}
\end{center}

\begin{itemize}
    \item \textbf{Addressing}
        \begin{itemize}
            \item Unicast: 128bits
                \begin{itemize}
                    \item 64bits for routing prefix and subnet id
                    \item 64bits for interface identifier
                    \item Global= 2000::...., 3FFF::....
                    \item Link local= FE80:0:0:0:....
                \end{itemize}
            \item Multicast: FF..::....
        \end{itemize}
    \item IPv6 Neighbor Discovery relies on multicast messages to:
        \begin{itemize}
            \item Router discovery (find router forwarding packets)
            \item Prefix discovery (find addresses using the prefix)
            \item Address resolution (replacing ARP for IPv4)
            \item Duplicate address detection
            \item Parameter discovery (MTU,...)
        \end{itemize}
\end{itemize}

\subsection{6LoWPAN}
IPv6 on 802.15.4:
\begin{itemize}
    \item IPv6 Header Compression (HC1): leave out unnecessary IPv6 header fields
    \item Fragmentation: because minimum IPv6 MTU = 1280 and Maximum
        frame size = 127bytes
    \item Link layer forwarding in mesh networks
\end{itemize}


\subsubsection{Stacked Header}
\begin{center}
    \includegraphics[width=0.7\linewidth]{img/stacked.png}
\end{center}

First byte (\textit{dispatch byte}) defines header type:
\begin{tabular}{rcl}
    00xxxxxx&:& not a 6LoWPAN frame\\
    01xxxxxx&:& IPv6 header (source/destination addr., etc.)\\
    10xxxxxx&:& Mesh header (for multi-hop forwarding)\\
    11xxxxxx&:& Fragment header (if packet is fragmented)\\
\end{tabular}

\paragraph{}

First byte for IPv6 header define IPv6 type: 
\begin{tabular}{rcl}
    01000001&:& uncompressed IPv6 header follows\\
    01000010&:& HC1-compressed IPv6 header follows (RFC 4944)\\
    011xxxxx&:& LOWPAN\_IPHC (RFC 6282)\\
\end{tabular}


\subsubsection{HC1}
\begin{itemize}
    \item \textbf{HC1 Header}: Ideally \begin{tabular}{l}
            First 64bits of IPv6 = link-layer address of 802.15.4 network\\
            Last 64bits of IPv6 = link-layer address (MAC)
        \end{tabular}

        $\Rightarrow$ No need to repeat them again in the HC1
        Header.

        \begin{center}
            \includegraphics[width=0.9\linewidth]{img/HC1.png}
        \end{center}

    \item UDP Header Compression: If HC2 bit is set, a HC2 byte
        immediately follows the HC1 byte (before the hop-limit field)
        \begin{center}
            \includegraphics[width=0.7\linewidth]{img/UDP.png}
        \end{center}

        2bytes are also append for UDP checksum

        \proitem{} HC1+HC2 compression reduce UPD+IPv6 header to
        7bytes in the best case (link-local unicast addresses already
        contained in 802.15.4 frame)

        \consitem{} Advantage is lost if the 6LoWPAN device has to
        communicate with devices external to the 6LoWPAN $\Rightarrow$
        Routable addresses needed

        \begin{itemize}
            \item Full prefix has to be specified (64bit)
            \item Full IID has to be specified (64bit)
            \item Same for multi cast to IPv6 addresse
        \end{itemize}

\end{itemize}


\subsubsection{LOWPAN\_IPHC compression}
Replace HC1 Header
%TODO


\section{Routing with RPL}

\subsection{Routing Protocols}

There are two classes of routing protocols:
\begin{itemize}
    \item Link-State: Each node knows network topologu and runs a shortest-path 
        algorithm $\to$ powerful but require more resources
    \item Distance-Vector: a node only needs to know which neighbor leads
        to which node.
        \begin{itemize}
            \item Each node maintains for each destination, the minimum distance
                and the neighbor to forward to.
        \end{itemize}
\end{itemize}

\paragraph{Count To Infinity problem with DSV routing}
\begin{figure}[ht!]
    \centering
    \begin{tikzpicture}
        \node[shape=circle,draw](a){A};
        \node[shape=circle,draw,right of=a](b){B};
        \node[shape=circle,draw,right of=b](c){C};
        \node[shape=circle,draw,right of=c](d){D};

        \draw[-] (a) -- (b);
        \draw[-] (b) -- (c);
        \draw[-] (c) -- (d);
    \end{tikzpicture}
    \caption{Count-To-Infinity, distance metric: number of hops}
\end{figure}

\begin{enumerate}
    \item Initial state: B knows that A is 1 hop away
    \item A disappears. B removes it from its routing table
    \item Before B notifies C, C sends that A is 2 hop away to B
    \item B thinks it has found a new path to A, so it store this path
        and send that A is 3 hop-away
    \item C update its routing table A is 4 hop away and sends
    \item \ldots
\end{enumerate}

\subsection{RPL}

RPL is a routing protocol designed for Low-power and Lossy Networks (LLN).
Characteristics of such networks:

\begin{itemize}
    \item Lossy,slow and unstable links
    \item Traffic mostly flows form devices to a server/sink or border
        router( or in opposite direction)
    \item Large number of nodes
    \item Constrained devices with small memory
\end{itemize}

\subsubsection{Routing Topology}

Topology represented as a Destination Oriented Directed Acyclic Graph (DODAG)
where the root is a server, border router, etc.
\begin{figure}[ht!]
    \centering
    \begin{tikzpicture}
        \node[shape=circle,draw,fill=green](root){0};
        \node[shape=circle,draw,below left of=root](c1){1};
        \node[shape=circle,draw,below right of=root](c2){1};
        \node[shape=circle,draw,below left of=c2](c3){2};
        \node[shape=circle,draw,below right of=c3](c4){3};
        \node[shape=circle,draw,below left of=c3](c5){3};

        \node[left =1cm of root](ds){};
        \node[below =2cm of ds](de){};

        \node[right =1cm of root](us){};
        \node[below =2cm of us](ue){};

        \draw[->] (c1) -- (root);
        \draw[->] (c2) -- (root);
        \draw[->] (c3) -- (c1);
        \draw[->] (c3) -- (c2);
        \draw[->] (c4) -- (c3);
        \draw[->] (c5) -- (c3);
        \draw[->] (c4) -- (c2);
        \draw[->] (c5) -- (c1);

        \draw[->] (ds) -- (de);
        \draw[->] (ue) -- (us);
    \end{tikzpicture}
    \caption{root in green, number correspond to node rank}
\end{figure}
\begin{itemize}
    \item Not a tree as they are multiple path possible for a destination.
    \item An RPL instance is a set disjoint DODAGS
    \item You can have multiple RPL instances on the same physical network
    \item Each RPL control messages carry a DODAG ID and a RPL-instance ID
    \item Rank is node property, typically proportional to path cost but coarser.
        The rank of node must be greater than rank of parent.
\end{itemize}

\subsubsection{RPL Control Messages}
\begin{itemize}
    \item \textbf{DAG Information Object (DIO)}
        \begin{itemize}
            \item Link-local multicasted by existing RPL nodes to advertise a DODAG
            \item Sent periodically by but also on request when routing problem detected
            \item Contains rank od sending node and network prefix
            \item Nodes find parent(s) in this way
            \item Multiple parents possible. Choice depends on path costs
        \end{itemize}
        $\Rightarrow$ Nodes know about possible parents and routes up toward DODAG root
        established.

        \paragraph{Version Number} When the root advertises a DODAG with
        the DIO message, it also includes a version number
        \begin{itemize}
            \item A that joins a DODAG with version X ignores lower versions
            \item When a node receives a message with higher version, it can move to that 
                version $\to$ new rank and parent
        \end{itemize}

        The root can decide to increase the version number and advertise
        a new version of the DODAG. It typically happens when a problem
        with current DODAG is detected and there is a repair.

        \paragraph{Path Cost} To compute how expensive a path is, the
        DODAG can define a Objective Function that the nodes must used.
        Cost can expressed in terms of:
        \begin{itemize}
            \item Signal quality
            \item Throughput
            \item Delay
        \end{itemize}

    \item \textbf{Destination Advertisement Object (DAO)}
        \begin{itemize}
            \item DAO messages travel up and forwarded to root
            \item Are unicasted to parent (or link-local multcasted to help for 
                direct P2P traffic)
            \item The goal is to propagate information about children(new and disappeared)
                so that parents can populate their routing table.
        \end{itemize}
        $\Rightarrow$ Routes down away from root established

    \item \textbf{DODAG Information Solicitation (DIS)}
        Node send DIS message to request DIO when:
        \begin{itemize}
            \item A new node want to joins an RPL instance
            \item A sleeping node wakes up and needs recent information
                about the network or want to inform the network that it is back
            \item A node cannot reach the router anymore $\to$ looking
                for a new parent
        \end{itemize}
\end{itemize}


\subsection{Packet Forwarding}
\begin{itemize}
    \item In up direction $\Rightarrow$ Packet is sent to lower rank (or
        siblings, if no lower rank)
    \item In down direction $\Rightarrow$ Node knows route to
        destination thanks to DAO message
\end{itemize}
Node only store information about next hop to destination, it's a DSV
with ranks.

\subsubsection{Loop Avoidance Mechanism}

\begin{itemize}
    \item \textbf{IPv6 header option}

        There is a direction flag in the header indicating the expected direction
        of a data packet:
        \begin{itemize}
            \item Sender sets the direction
            \item If an up-packet is forwarded from a node A to a node B with 
                higher rank, a problem is detected by B (same in opposed situation)
            \item Node B sets the R (repair flag) in the packet. This indicates
                that the DODAG has to be repaired
        \end{itemize}

    \item \textbf{Node movement}
        Node might find better parents:
        \begin{itemize}
            \item New nodes appear or old nodes disappear
            \item Signal strength changes
        \end{itemize}
        However, node are only allowed to move up toward the root $\Rightarrow$ A node
        cannot become a child of one of its children.
\end{itemize}

\subsubsection{Trickle Timer}
A DIO message are sent to build new DODAG, on a DIS message and
periodically. To avoid that to send to many DIO when it's not necessary,
a Trikle Timer is run on each node:

\begin{itemize}
    \item $T_min$: minimum duration of the timer
    \item $T_max$: maximum duration of the timer
    \item $T$: current duration used by the timer
    \item $C$: number of good messages received by the node
    \item $K$: some threshold for C
\end{itemize}

\begin{small}
    \begin{lstlisting}[frame=single]
    T:= Tmin, C:=0
    t = rand(T/2,T)
    wait(event)

    if event == t expires and C<K:
    send DIO 
    restart t

    if event == T expires:
    T:= 2*T (up to Tmax)
    restart T

    if event == good DIO:
    C:= C+1
    if event == bad DIO:
    C:= 0
    T= Tmin
    \end{lstlisting}
\end{small}

\begin{itemize}
    \item C is increased by 1 for every good message = DIO that does not announce a
        change
    \item C is reset to 0 and T is reset to $T_min$ for bad message= DIO that 
        announces a change or with R flag.
\end{itemize}
Good message indicate a stable network and because T is increased,
nodes send DIS messages less messages less frequently.


\section{Constrained Application Protocol}

An HTTP-inspired protocol designed for constrained devices and networks
used for RESTful access to resources. Default port is 5673 (coap) adn
5684(coaps). 

\begin{tabular}{lm{10cm}}
    Key features:&
\begin{itemize}
    \item Low overhead
    \item Easy to implement
    \item For Machine-2-Machine communication
    \item Simple mapping to HTTP for CoAP-HTTP proxies
\end{itemize}
\end{tabular}

CoAP messages provide reliable messaging over UDP and consist of a set of
method that resemble HTTP request methods and response code.
\begin{figure}[ht!]
    \centering
    \includegraphics[width=0.5\linewidth]{img/coap-layer.png}
\end{figure}

\subsection{Message Format}
\begin{itemize}
    \item Messages are exchanged between UDP end-point
    \item they have the same format for request and response. 
    \item[$\rightarrow$]Header and options are in binary format.
\end{itemize}

\begin{figure}[ht!]
    \centering
    \includegraphics[width=0.5\linewidth]{img/coap-format.png}
\end{figure}

Message are compact $\Rightarrow$ avoid IP fragmentation and easy parsing.

\subsubsection{Fields}
\begin{description}
    \item[Ver:] Version number(01). Unknown versions are silently ignored.
    \item[Code:] \begin{tabular}{l}
            Method Code in request\\
            Response Code in responses
            \end{tabular}

        \begin{itemize}
            \item Method similar to HTTP: GET(0.01), POST(0.02), PUT(0.03), DELETE(0.04)
            \item Response codes similar to HTTP responses code: ok (2.05), not found
                (4.04),\ldots
            \item URI and additional options are stored in the options fields.
        \end{itemize}

    \item[Options:] Additional (0 or more) options, end marked by 1111111
        \begin{itemize}
            \item Options identified by their option code
            \item Option Code = Delta + previous option code
            \item Option length = length of option in bytes
            \item Delta is used to indicate presence of extension fields
        \end{itemize}
        
        \paragraph{URI} An URI such as
        \texttt{coap://example.com:5683/sensors/temp?x=1\&y=2} is not
        stored as one big string in a request but it is store as option.
        \begin{itemize}
            \item Host name in Uri-Host option (code 3)
            \item Port in Uri-Port option (code 7)
            \item Path segments in one or more Uri-Path options (without /)
            \item Query arguments in one or more Uri-Query (without \& and ?)
        \end{itemize}
        $\Rightarrow$ Simplifies parsing.

    \item[Token:] A 0 to 8 bytes value (length in TKL) generated by the
        client for concurrent request. Request for same
        source-destination should have unique token number.

        \begin{itemize}
            \item Response will use same number as the request
            \item Responses with unexpected token number are rejected
        \end{itemize}

        \paragraph{Security}
        CoAp connection can use \textbf{Datagram Transport Layer Security} which is like TLS but
        for UDP. If DTLS is not used, token should be long randomized token value to
        prevent response spoofing.

    \item[T:] Specifies the type of the message:
        \begin{itemize}
            \item Confirmable(0)
            \item Non-confirmable(1)
            \item Acknowlegment(2)
            \item Reset(3)
        \end{itemize}
\end{description}

\subsection{Transmission}
Depending on the type of the message, its treatment will be different.

\begin{itemize}
    \item \textbf{Transmission without Reliability}:
        Lightweight and useful for repeated operations, it applies to request or response
        of type \textcolor{red}{Non-confirmable}.
        \begin{itemize}
            \item Message might be sent multiple times by sender or network so each copy
                as a unique message ID to identify them.
            \item Message is ignored by recipient if unexpected or ill-formatted
                (unknown codes, wrong token value) $\to$ Recipient may send Reset 
                message with same message ID
        \end{itemize}

    \item \textbf{Transmission with Reliability}
        This applies to message of type \textcolor{red}{Confirmable}, Message ID
        is crucial but not only for de-duplication. Indeed, recipient must either
        reply with:
        \begin{itemize}
            \item Acknowledgement (with same message ID) or 
            \item Reset (with same msg ID) and ignore the message
        \end{itemize}

        Sender retransmits Confirmable message until ACK or Reset received 
        (or runs out of attempts).

        \paragraph{Retransmission} Exponential back-off

\begin{lstlisting}[frame=single]
    ACK_TIMEOUT = 2s
    ACK_RANDOM_FACTOR = 1.5
    MAX_RETRANSMIT = 4

    timeout := rand(ACK_TIMEOUT, ACK_TIMEOUT*ACK_RANDOM_FACTOR)
    retransmission-counter := 0

SENT: 
    send CON message
    wait until timeout or ACK or RESET
    if timeout and retransmission-counter < MAX_RETRANSMIT:
        timeout := timeout*2
        retransmission-counter++
        go to SENT
\end{lstlisting}
\end{itemize}

\subsection{Message Exchange}

\subsubsection{Synchronous Message Exchange}
\begin{minipage}{0.5\textwidth}
    \begin{figure}[H]
        \includegraphics[width=0.5\linewidth]{img/syn-exchange.png}
    \end{figure}
\end{minipage} \hfill
\begin{minipage}{0.45\textwidth}
    \begin{itemize}
        \item Request sent as CON message
        \item Response sent as ACK message (piggybacking)
        \item Efficient
    \end{itemize}
\end{minipage}


\subsubsection{Asynchronous Message Exchange}
\begin{minipage}{0.5\textwidth}
    \begin{figure}[H]
        \includegraphics[width=0.5\linewidth]{img/asyn-exchange.png}
    \end{figure}
\end{minipage} \hfill
\begin{minipage}{0.45\textwidth}
    \begin{itemize}
        \item Request sent as CON message
        \item Recipient replies immediatel with empty ACK message (code 0.00)
        \item Recipient replies later with actual response in CON message
        \item More overhead than piggybacking
        \item Tokens for matching request <-> response
    \end{itemize}
\end{minipage}

\paragraph{Remarks}
\begin{itemize}
    \item CON and NON-CON messages can be mixed, ex: request as NON-CON and
        response as CON
    \item Empty CON (code 0.00) can be used as ping message, recipient replies with
        RESET message
    \item No definition of how long request should wait for response, CON-ACK 
        mechanism is only about reliable transmission
\end{itemize}

\subsection{CoAP Features}

\subsubsection{Multicasting and Discovery}
\begin{itemize}
    \item CoAP supports requests to IP multicast groups. Different behavior
        if request is multicast:
        \begin{itemize}
            \item Servers must not reply RESET to unwanted NON-CON messages 
                $\Rightarrow$ avoid too many error responses
            \item Servers should wait random time before responding request
                $\Rightarrow$ avoid congestion
        \end{itemize}
    \item Multicasting is useful for automatic service discovery in M2M scenarios.

    \item Servers should also support resource discovery:
        \begin{itemize}
            \item Client sends \texttt{GET ./well-known/core} to server
            \item Server returns list of resources
        \end{itemize}
\end{itemize}

\subsubsection{Caching}
CoAp uses a simple caching mode with an \textcolor{red}{age} option
indicating cache lifetime. 

$\Rightarrow$ This useful for proxies to cache information of sleeping nodes
or to reduce network traffic

\paragraph{Optional ETag}
\begin{enumerate}
    \item Server can put an ETag string in response
    \item Client sends ETag when re-requesting a cached resource
    \item Server can respond with 2.03 (valid) if resource has not
        changed
\end{enumerate}

ETag can be used in PUT-requests with \texttt{If-Match-Option}: Only write 
new value if I have latest one $\Rightarrow$ protection against accidental
concurrent overwrites

\subsubsection{Other Features}
\begin{itemize}
    \item Observing resources
    \item Block transfer (specify wanted bytes in request)
\end{itemize}

\subsection{Spoofing Attack}
CoAp runs over UDP, no handshake \& sequence number
\begin{itemize}
    \item Third party can spoof RESET message to disrupt connection
    \item CoAP endpoints can be used for amplication \& reflection 
        attacks against other targets.
\end{itemize}

Security (DTLS) and careful implementation (random token) can prevent attack
to some degree.

\section{GSM}

\subsection{Fixed-line phone networks}
Fixed-line phone networks were originally circuit-switched
\begin{center}
    \includegraphics[width=0.5\linewidth]{img/fixed-line.png}
\end{center}
Connections were set up or teared through signaling protocol which information
exchange establish a connection. 

\subsubsection{Signaling protocols}
Two kinds of signaling protocols:
\begin{itemize}
\item \textbf{In-Band:} Signaling uses the same channel as the voice data
        \begin{enumerate}
            \item Human operator
            \item Pulse dialing
            \item Tone dialing
        \end{enumerate}

        \begin{itemize}
                \proitem{} Easy to implement 
                \consitem{} Fraud: end user can hack the signaling by
                creating the right pulse or tone sequence
        \end{itemize}

        SS5 (Signaling System No. 5) : set of protocols for in-band
        signaling

\item \textbf{Out-Band:} Separate digital channel and voice/data

        SS6 which used out-band was replaced by the more flexible and
        powerful SS7 which used out-band.
\end{itemize}

\subsubsection{SS7}
SS7 is a packet-switched protocol:
\begin{itemize}
    \item Message for call setup and tear down
    \item Also used for other kind of management information (billing,
        SMS,...)
\end{itemize}

\paragraph{Protocol stack}: Protocol stack similar to IP:
\begin{itemize}
    \item MTP-1 (Message Transfer Part 1): Physical layer
    \item MTP-2: data link layer, defines packets
    \item MTP-3: packet routing, packet have source and destination
        address called \textcolor{red}{point codes}
\end{itemize}
\begin{center}
    \includegraphics[width=0.5\linewidth]{img/ss7.png}
\end{center}

\begin{itemize}
    \item MTP-1 to MTP-3 only define basic signaling functionality
    \item There are other protocols that run on higher layers, for example protocols for core 
        network management, mobile call management, \ldots
    \item Nowadays SS7 runs over IP.
        \begin{itemize}
            \item MTP-1 replaced by Ethernet
            \item MTP-2 and MTP-3 replaced by IP/SCTP/...
        \end{itemize}
\end{itemize}


\subsection{GSM Component}
Global System for Mobile Communication, uses \textbf{SDMA},
\textbf{TDMA} and \textbf{FDMA}.
\begin{figure}[ht!]
    \centering
    \includegraphics[width=0.6\linewidth]{img/gsm.png}
\end{figure}

\subsubsection{Base Station Subsystem}
The base station subsystem contains all necessary components for the radio
communication.

\begin{center}
    \includegraphics[width=0.6\linewidth]{img/bss.png}
\end{center}

\begin{description}
    \item[Base Station Controller:] Control item such as handover and allocate
        channel for a call
    \item[Base Transceiver Station:] Radio Transmitter that can cover an area (cell) with
                radius of up to 35 km but can only serve limited number of users. 
        \begin{itemize} 
            \item Each BTS can use only a limited number of frequencies 
                because of interferences with neighbor cells
            \item To increase capacity, the coverage area of a BTS is usually
                split into two or three sectors
                \begin{center}
                    \includegraphics[width=0.4\linewidth]{img/cellular.png}
                \end{center}
        \end{itemize}


\end{description}

\paragraph{Characteristics}

\begin{itemize}
    \item \textbf{Frequency Band}
        \begin{itemize}
            \item \textit{GSM-900}:
                \begin{itemize}
                    \item 124 downlink carrier frequencies from 935.2 MHz to 960MHz( BS to MS)
                    \item 124 uplink carrier frequencies form 980.2 MHz to 915 MHz (MS to BS)
                    \item Each channel 200kHz bandwidth
                    \item 2 Watt transmission power in handset
                \end{itemize}

            \item \textit{GSM-1800}: 374 channels 1710-1880Mhz
        \end{itemize}

        $\Rightarrow$ For cost reasons, a GSM mobile station operates on
        only one frequency at a time, it can either receive or transmit
        at a time.

    \item \textbf{Timeslots}: Each carrier frequency is divided into 8
        repeating timeslot (\textcolor{red}{burst}) of 0.577ms
        $\Rightarrow$ \textbf{TDMA}

        \begin{itemize}
            \item The 8 timeslots of a carrier frequency are called
                \textcolor{red}{physical channel}, channel are
                identified by its frequency and timeslot number

            \item Number of physical channels determines how many simultaneous active MS the 
                base station can handle
        \end{itemize}
        During a timeslot, burst are sent. 

        \paragraph{Burst structure} 
        There exists different type of burst (synchronization,
        voice/datan...). For a normal burst used for voice and data 
        the structure is:
        \begin{center}
            \includegraphics[width=0.8\linewidth]{img/burst-structure.png}
        \end{center}

        \begin{description}
            \item[Start bit pattern] Gives time for the transmitter to ramp up its power
            \item[Data] 2 fields of 57 bits carrying information
            \item [S bits] One for each data field indicating that the data fields contain
                urgent signaling information instead of normal data
            \item [Training data] contains a fixed bit pattern, used by the receiver to 
                optimize its filter parameters in order to compensate for interferences
            \item [End bit pattern] Gives time for the transmitter to ramp down its power
            \item[Guard time] Prevent overlap between burst
        \end{description}

        \paragraph{Timing}
        TDMA requires \textbf{exact timing} but signal propagation time depends on distance
        between phone and base station. 
        \begin{itemize}
            \item Guard times at the end of the Normal Burst help but they are very
                short in GSM
            \item[$\Rightarrow$]Base Station measures the delay and
                sends signaling information to phone to adjust its
                timing
        \end{itemize}
\end{itemize}

\subsubsection{Logical Channels}
A logical channel (mapped to the physical channels) is channel dedicated to a specific type of 
information. Ex:
\begin{description}
    \item[TCH(Traffic Channel):] carries the voice and user data from/to a 
        mobile station
    \item[BCCCH(Broadcast Common Controm Channel):]used by the base station to 
        broadcast status information to all idle mobile stations
    \item[PCH(Paging Channel):] informs mobile stations about incoming calls or SMS
\end{description}

\paragraph{Mapping}

\begin{itemize}
    \item Compared to the traffic channel most logical signaling channel only carry few 
        information and therefore can be time-multiplexed on the same physical 
        channel:
        \begin{itemize}
            \item Typically, timeslots 0 and 1 of the first frequency of a base station are 
                used for signaling channels
            \item The other timeslots and frequencies are used for the traffic channel
            \item The base station manages the mapping
        \end{itemize}

    \item We than have \textbf{common} channels that can be used by all MS
        and \textbf{dedicated} channels assigned to specific MS.
\end{itemize}

%TODO: Example slide 22 for GSM

\paragraph{Example: Traffic Channel}
A dedicated channel used for voice or user data:
\begin{itemize}
    \item Full rate: 13 kbit/s
    \item Half rate: 6.5 kbit/s, two MS share a timeslot
\end{itemize}

When allocating the TCH for a MS, the BSC chooses timeslots in the down-link
frequency and the up-link frequency that are at least 3 timeslot periods
apart.

\begin{itemize}
    \item MS has enough time to switch from the down-link frequency to the
        up-link frequency
    \item MS needs only one transceiver
\end{itemize}

\subsubsection{Network Subsystem}
\begin{figure}[ht!]
    \centering
    \includegraphics[width=0.7\linewidth]{img/nss.png}
    \caption{Signaling with SS7 protocols running on top of MTP-3}
\end{figure}

\begin{description}
    \item[Mobile Switching Center:] MSCs are responsible for switching phone
        calls between mobile stations or with fixed-line phones. Responsible for
        one or several BSS
    \item [Gateway-MSC:] The same as MSC but with a gateway to Public Switched
        Telephone Network (PSTN).
\end{description}

Since MS can roam freely between cells and even between operators, the MSC
must keep track of the location of the MS, otherwise, calls to the MS can not be
routed to the right BSS.

\paragraph{Informations stored}
An MSC has access to several detabases that store information about subscribers:
\begin{itemize}

    \item \textbf{Equipment Identity Register (EIR):} List of blocked, faulty,
        to-be-monitored device

    \item \textbf{Home Location Register (HLR):} it is the subscriber
        central database of a GSM network, it contains a record for each
        subscriber (Each subscriber has a home area that served by
        exactly one HLR). A record contains for each SIM card:

        \begin{itemize}
            \item International Mobile Subscriber Identity (IMSI) = Unique ID
            \item One or more Mobile Subscriber International ISDN Numbers = Phone numbers
            \item Profile data (name, roaming limits etc.)
            \item Temporary data: current \textcolor{red}{VLR,MSC} 
        \end{itemize}

        $\Rightarrow$ \textbf{master table of the GSM operator,
        containing a record for each subscriber}

    \item \textbf{Visitor Location Register (VLR)}: Local database to
        reduce signaling between MSC and HLR. 

        \begin{itemize}
            \item It contains information from HLR when MS enters the
                VLR's service area (each BS served by exactly one VLR):
                \begin{itemize}
                    \item Subscriber's ID number and phone number
                    \item Service profile
                    \item HLR address
                    \item Roamin number: temporary phone number that can be used to find MS 
                        (MSC number)
                    \item \ldots
                \end{itemize}

            \item Typically implemented in the MSC
            \item Location area identity to further reduce signaling
                with HLR
        \end{itemize}

    \item Localization: Service areas are divided into smaller location
        areas (LA).

        $\Rightarrow$ Small mobility of subscriber does not cause remote HLR update

        \begin{center}
            \includegraphics[width=0.8\linewidth]{img/burst-structure.png}
        \end{center}

\end{itemize}

\paragraph{IMSI and MSIDN}
IMSI is the key identifying a SIM card, it stored in the HLR and on the SIM card
but the MSIDN (phone numbers) are not stored on SIM card.

\begin{tabular}{cm{10cm}}
    When MS is switched on:&
    \begin{enumerate}
        \item MS sends IMSI to MSC
        \item MSC analyses the country code and network code
        \item MSC sends request to HLR to retrieve the record
    \end{enumerate}
\end{tabular}

$\Rightarrow$ Advantages of separating IMSI and MSISDN: MSISDN can be
changed afterwards

\subsubsection{Handover}

Because MS can move freely, so MS can move from one cell to
another. BSC can decide to de a handover based on signal quality:

\begin{itemize}
	\item BTS constantly measures signal quality and reports to BSC
	\item MS also reports quality of signals it receives from other cells
\end{itemize}

\paragraph{Scenarios} 3 different scenarios:
\begin{itemize}
	\item Intra-BSC handover: old and new cell connected to same BSC
	\begin{enumerate}
		\item BSC activates a TCH in new cell
		\item BSC informs LS via old cell to handover to new TCH
		\item Once MS and BTS have confirmed handover, BSC redirects
		voice data to new cell and deallocates old TCH
	\end{enumerate}

	\item Inter-BSC handover: old and new cell connected different BSCs,
	but same MSC
	\begin{enumerate}
		\item BSC of old cell asks MSC to initiate handover
		\item MSC asks BSC of new cell to prepare a TCH
		\item MSC notifies MS to handover
		\item Once MS and BSC have confirmed handover, MSC redirects voice
		data and tells old BSC to close old TCH
	\end{enumerate}

	\item Inter-MSC handover
	\begin{enumerate}
		\item Old MSC sends handover request to new MSC
		\item New MSC contacts new BSC to establish TCH
		\item MSC notifies MS to handover
	\end{enumerate}
	The first MSC still stays responsible for the call, the call is routed from
	the G-MSC through the anchor MSC to the new MSC
\end{itemize}

\subsubsection{Security}
GSM security consist of Authentication and encryption:

\begin{itemize}
	\item \textbf{Authentication:} MS is authenticated

        Symmetric Key Ki(max. 128 bits) for IMSI stored in SIM
        card and in Authentication Center
        \begin{enumerate}
            \item Authentication Center generates:
                \begin{itemize}
                    \item a 128 bit random number RAND
                    \item a 32-bit signed responses SRES = A3(Ki,RAND)
                \end{itemize}
            \item MSC sends RAND to MS
            \item SIM card also computes SRES
            \item Response sent back to MSC
            \item MSC compares responses
        \end{enumerate}
        The A3 algorithm is not standardized. 
        \begin{itemize}
            \item New RAND and SRES generated for each authentication
            \item For speed-up, several RAND/SRES computed  in advance and
                buffered in MSC and VLR
        \end{itemize}

    \item \textbf{Encryption:} Communication between MS and BTS is encrypted

        Data exchanges between MS and BTS are encrypted,
        \begin{itemize}
            \item Creation of a 64-bit session key Kc = A8(Ki,RAND) by the 
                Authentication center
            \item MSC sends RAND to MS, so MS can also compute Kc
            \item Session key can be changed, at reqular intervals
        \end{itemize}
        MSC and MS use Kc and A5 algorithm to encrypt/decrypt data.
        A5 is a set of algorithms A5/1, A5/2...
        \begin{itemize}
            \item Input:
                \begin{tabular}{m{10cm}}
                    Kc\\
                    Current frame number N: different for every burst
                \end{tabular}
            \item Output:
                \begin{tabular}{m{10cm}}
                    114-bit sequence C=A5/x(Kc,N)
                \end{tabular}

            \item Encryption:
                \begin{tabular}{m{10cm}}
                    Encrypted burst = Original burst data XOR C
                \end{tabular}
        \end{itemize}
\end{itemize}

The keys of IMSI are stored in Authentication Center and in SIM card
and algorithm are implemented in the GSM network and on the SIM
card.

\paragraph{Strength and Weaknesses}
\begin{itemize}
        \proitem{} Keys and key generation inside SIM card, not by phone software
		\consitem{} A3/A5/A8 algorithm were secret and not publicly discussed
		\consitem{} 128 bit key length: Too short for modern computers
		\consitem{} Communication between BTS and BSC not encrypted
		\consitem{} MS is authenticated to network but not vice versa
		\consitem{} Network operator knows all keys
		\consitem{} No end-to-end authentication \& encryption
\end{itemize}

\section{GPRS}
IP traffic can be transmitted on TCH but GSM is a circuit-switched network:
\begin{itemize}
	\item Good For voice but cumbersome for packet traffic
	\item Data is circuit-switched between MS and gateway to Internet
\end{itemize}
Circuit-switched network have some disadvantages:
\begin{itemize}
	\item Resource are wasted as an entire physical is allocated to one end-point
	while Internet traffic is typically bursty
	\item Subscriber has to pay time, even when e-mail client is just waiting
	for incoming e-mails
	\item GSM is slow, 13 kbit/s
\end{itemize}
\subsubsection{HSCSD}
HSCSD = High Speed Circuit Switched Data was the first attempt to performance
of GSM for data transfer. Key Idea:
\begin{itemize}
	\item Requires only small changes in the MSC
	\item Bundling of time slots
	\item Bundling of channels (asymmetric: 1 up, 3 or 4 down)
	\item Up to 115.2 kbit/s (in practice 57.6 kbit/s)
\end{itemize}
Faster than GSM, but it's still circuit-switched.

\subsection{GPRS Principles}
General Packet Radio Service:
\begin{itemize}
	\item GSM extension for packet based data transmission
	\item Require changes in BSS and NSS
	\item up to 170 kbit/s, typically 85kbit/s
\end{itemize}
\subsubsection{Channels}
Bursty packet traffic in GSM means a low utilizarion of allocated TCH.
GPRS introduce a new channels: 
\begin{itemize}
	\item PDTCH (Packet-Data TCH):
	\begin{itemize}
		\item One physical channel like TCH
		\item But: block of 4 bursts on PDTCH assigned to MS
		\item Network can decide to assign the next block to 
			another MS
	\end{itemize}
	\item Timeslot bundling: up to 5 downlink timeslots and up
	to 3 uplink timeslots
	\item New channel PACCH to send acknoledgments
\end{itemize}
There are other new channels but signaling is pretty similar to ordinary voice
calls:
\begin{itemize}
	\item MS send message on RACH to request PDTCH
	\item MS receives answer on AGCH
\end{itemize}

\subsubsection{Coding Schemes}
Depending on quality of connection (bit errors), BS and 
MS can choose between 4 coding schemes with different amount 
of error correction information $\Rightarrow$ more correction 
information means less relevant data.

\subsection{EDGE}
EDGE enhances GPRS to provide better perfomance, 150-200kbit/s. GSM and
GPRS use Phase-Shift Keying modulation with two possible phases but its 
different for EDGE:
\begin{itemize}
	\item Uses PHSK with 8 possibles phases meaning that it can transmit
	3 bits where GSM/GPRS transmit 1 bit
	
	\item Requires new radio interfaces in the BTS and MS
	\item Support different coding scheme that is selected dynamically depending
	on transmission quality (measure by BTS and MS)

\end{itemize}

\subsection{GPRS core network}
GPRS introduces new nodes in the core network to support 
packet-switched data transfer:
\begin{figure}
	\centering
	\includegraphics[scale=0.5]{img/gprs.png}
\end{figure}
\begin{description}
	\item[Gateway GPRS support node (GGSN):] Gateway to Internet
	\item[Serving GPRS support node (SGSN):] node between MSC and
	BS, does all the packet handling, routing, \ldots
\end{description}

\subsection{GPRS operation}
GPRS operation similar to GSM, phone connects to network, authenticates itself 
and request traffic channel. MS communicates with SGSN and GGSN.

 \subsubsection{Encryption}
 Encryption is done between the MS and SGSN:
 \begin{itemize}
	\item Advantages:
	\begin{itemize}
		\item More secure, since communication between BTS and BSC is often carried 
		over microwave links
		\item Better support for mobility: MS can smoothly move to a different cell 
		of the SGSN without too much overhead
	\end{itemize}
	\item Drawbacks:
	\begin{itemize}
		\item SGSN must have more processing power than BTS because it has 
		to encrypt/decrypt traffic for many MS
	\end{itemize}
\end{itemize}

\subsubsection{Connection Management}
\begin{itemize}
	\item When opening a connection, PDP (Packet Data Protocol) context is
	created
	\item No dedicated channel resources allocared for PDP: MS can stay
	always ''connected'' to Internet wihtout using resources
	\item PDTCH only used when needed
\end{itemize}

\subsubsection{IP traffic routing in GPRS}
Together wiht the PDP context, the GGSSN allocates an IP address for the MS.
The traffic is transported over IP between the GGSN and the current SGSN of
the MS.\\
When MS roams to a new SGSN $\Rightarrow$ Route change so the IP address
of the MS is changed
\paragraph{GPRS Tunneling Protocol (GPT)}
Protocol that runs on top of UDP:
\begin{itemize}
	\item GTP packet contains the IP adress of the MS
	\item UDP packet contains the address of the current SGSN
	\begin{itemize}
		\item Set by the GGSN when the traffic enters the GPRS network
		from the Internet
		\item GGSN is informed whenever the MS changes to a different
		SGSN
	\end{itemize}
\end{itemize}
When you have roamed to a different operator, your IP traffic is routed to the 
GGSN of your home operator

\section{UMTS}

\end{document}
