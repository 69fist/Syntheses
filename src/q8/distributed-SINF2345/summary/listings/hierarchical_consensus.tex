\begin{lstlisting}[caption=Hierachical consensus, mathescape, captionpos=b]
upong event <Init> do
    detected :=  $\empty$
    round    := 1
    proposal := $\top$
    lastprop := 0

    for i=1 to N do
        broadcast[i] := delivered[i] := false

upon event <Crash | p$_i$ do
    detected := detected $\cup$ {rand(p$_i$)}

upon event <cPropose | v> do
    if proposal = $\top$ then
        proposal := v

upon round = rand(self) and
     broadcast[round] = false and
     proposal != $\top$ do

    broadcaset[round] := true
    trigger <cDecide | proposal>
    trigger <bebBroadcast | (DECIDED, round, proposal)>

upond event <bebDeliver | p$_i$, (DECIDED, r, v)> do
    if r > lastprop then
        proposal := v; lastprop := r
    delivered[r] := true

upon delivered[round] or round $\in$ detected do
    round := round + 1
\end{lstlisting}
